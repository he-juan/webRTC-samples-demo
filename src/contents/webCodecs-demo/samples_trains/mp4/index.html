<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WebCodec MP4 frame extration demo</title>
</head>
<body>
  <h1> video 播放</h1>
  <video controls autoplay muted>
     <source src = bbb.mp4 type="video/mp4" />
  </video>
  <br/>

  <h1>canvas 获取</h1>
  <p>
      Frames extracted: <span id="frameStats"></span>
  </p>
  <canvas></canvas>

  <script src="./mp4box.all.min.js"></script>
  <script type="module">
      import {MP4Demuxer} from "./mp4_demuxer.js";
      const demuxer = new MP4Demuxer("./bbb.mp4");
      console.warn("demuxer:",demuxer)
      const canvas = document.querySelector('canvas')
      const ctx = canvas.getContext('2d')
      let frameCount = 0;
      let startTime;
      document.body.appendChild(canvas)

      demuxer.getConfig().then((config) => {
          console.warn("config:",config)
          canvas.height = config.codedHeight
          canvas.width = config.codedWidth
          decoder.configure(config)
          demuxer.start((chunk) =>{
              decoder.decode(chunk)
          })
      })
      let decoder = new VideoDecoder({output: onFrame, error: e => console.warn(e),})

      async function onFrame(frame){
          // console.warn("frame:",frame)
          let now = performance.now();

          ctx.drawImage(frame, 0, 0, canvas.width, canvas.height);
          frame.close();

          let fps = "";
          if(frameCount++) {
              let elapsed = now - startTime;
              fps = " (" + (1000.0*frameCount/(elapsed)).toFixed(0) + " fps)"
          } else {
              // This is the first frame.
              startTime = now;
          }

          document.getElementById("frameStats").innerText = frameCount + fps;
       }

      window.decoder = decoder


  </script>
</body>
</html>