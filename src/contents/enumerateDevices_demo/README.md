[TRTC能力检测](https://web.sdk.qcloud.com/trtc/webrtc/demo/detect/index.html)

## 一、webrtc 的特点
 1.什么是WebRTC？
   - 全称web实时通信，是一种关于实时通信的解决方案。基于html，http，tcp/ip等这类技术实现。

 2.WebRTC的特点：
  - webrtc在浏览器中api中集成了很多技术，主要用于解决一些繁重的问题，比如：捕捉摄像头和麦克风，音视频编解码，传输层以及会话（session）管理

    - 捕捉摄像头和麦克风：

       - 获取设备摄像头和麦克风权限，检测设备可用性，获取用户授权并与设备建立连接，从设备获取一段数据流，准备就绪后就可开始实现应用。

    - 音视频的编解码：
       - 对尺寸较大的视频帧和音频波采取分解措施，后再压缩到更小，可以使其在网络中快速传输，接收时解压，这样的过程被称为多媒体数字信号编解码。
       -  WebRTC的内置编解码器有：H.264，Opus，iSAC，VP8，当浏览器会话时会根据双方设备选出最优编解码器

    - 传输层：
       - 主要处理数据丢包，数据包排序，建立用户间链接等，通过传输层api可以轻松获知用户网络间的波动，并及时对链接的变化做出反应。

    - 会话管理：
       - 负责在浏览器中建立并管理多个连接


   > `获取媒体：getUserMedia()`

   > `建立对等连接：RTCPeerConnection`

 

 3.webRTC的适用范围：
   - firefox,opera,台式机,Android的chrome中,ios,Android上的本机应用程序

 4.信令：
   - 用来协调通信并发送控制消息的指令.webRTC没有指定的信令方法和协议
   
   - 信令或控制服务器是无法向终端设备中推送信令代码，因此，实现互操作功能的唯一方式是：让两个终端使用统一标准化信令协议，例如Sip和Jingle    

   - 使用HTTP传输信令的做法叫做表述行状态传输或RESTful信令。

   > 1.HTTPS比HTTP更为安全，因为HTTPS允许浏览器对信令服务器进行身份验证。

   > 2.为了能够访问WebSocket服务器，它必须拥有公共IP地址，并且运行HTTP服务器，这意味着无法直接与另一个浏览器开通WebSocket，因为浏览器实施的是HTTP用户代理功能而非HTTP服务器功能，因此任然需要WebSocket服务器在使用WebSocket的两个Web客户端之间提供中继。及时计算机运行的是HTTP服务器，NAT便利也会组织在Internet上的两台计算机之间吉利端到端WebSocket链接。浏览器通过WebSocket API来使用WebSocket。

   > 3.所有主流浏览器供应商都支持WebSocket，但是，某些Web代理和防火墙并不完全支持WebSocket并可能导致问题，尤其是在身份验证方面。

 -----
 
## 二、websocket传输
  > WebSocket传输允许浏览器开通一个与服务器的双向连接。此链接最初采用HTTP请求形式，但随后升级为WebSocket。只要服务器支持CORS，WebSocket服务器的IP地址就可以不同于Web服务器。 
      任何信令都可以通过WebSocket进行传输。
----

## 三、数据通道传输
  > 挡在两个浏览器之间建立数据通道后，他就会提供直接的低延迟连接，这是其非常适用于传输信令。由于最初建立数据通道是需要单独的信令机制，因此数据通道无法单独用于传输所有的WebRTC信令。但是，一旦建立数据通道，即可使用它来处理所有信令，包括用于通过对等连接传输的音频和视频媒体的所有信令。
利用数据通道传输信令的一个好处在于，它有助于缩短用户感知的建立连接所需的时间。在浏览器之间交换没踢之前，必须先完成ICE和ETLS-SRTP秘钥管理步骤。如果等到被叫方用户接受会话后才开始执行这些步骤，则会出现明显的延迟，最长时间可能达到几秒。利用数据通道传输指令时，将执行ICE和DTLS秘钥管理来建立数据通道，这可以发生在提示或要求用户接受会话之前。当用户接受会话后，将能够以相当快的速度天添加语音和视频，因为信令消息将直接传输至另一端的浏览器，媒体流可重复使用对等连接，则无需执行ICE或DTLS-SRTP处理。

 1.信令协议
   - WebRTC信令协议的选择很重要且不必局限于所选的信令传输方式
   - 采用任何信令协议都会存在信令状态机，对于状态机中的每一种状态，并非都需要在两个浏览器之间交换信令消息，但存在某些信令方案有这样的效果。
   - 标准信令协议的优点：已存在完全定义的状态机。信令消息将包含有助于路由的信息。
   - 采用专有信令协议的优点：他可以非常简单，并且只提供应用程序所需的功能。如果webRTC对等链接使用仅限于两个浏览器，而不通过中间环节或不通向SIP或JingleVoIP或是视频终端则是核材与专有信令协议
      - 除信令之外，还可以通过另一种方式来确认身份，即标识连接而非用用，例如在url中添加连接标识符。
 
 2.信令标识
   - 如果浏览器和服务器之间的给定连接可通过令牌标识，则发送至服务器的信令消息可包含另一个”服务器至浏览器”连接的令牌。于是web服务器代码将在两个连接之间充当代理或用于转发信息。有两个例子可用于说明此方案：

 3.使用WebSocket代理：
   - 用来传输WebRTC心灵的WebSocket代理，其使用的雾浮起将具有公共IP地址并可由建立对等连接的两个浏览器访问。每个浏览器将分别与该服务器开通一个独立WebSocket连接，服务器则将两个链接桥接在一起，以代理身份将信息从一个浏览器发至另一个浏览器，。JavaScript不支持DNS查找，所以web服务器需要以IP地址和端口号的形式来提供web Socket服务器。

 4.使用Google应用程序引擎通道API：
   - 使用Google用用程序引擎通道API作为信令通道，JavaScript客户端可与Google云中的服务器建立通道，此通道API使用XHR将来自浏览器的信令消息发送至Google服务器。它使用统称为Comet的技术将消息转发给另一个浏览器。Comet采用HTTP长轮询技术，又称为AJAX，AJAX推送或HTTP服务器推送。这通常涉及让客户端向服务器发送一个请求，并使该请求保持打开状态，直到服务器向客户端发送信息，服务器通过应用程序引擎通道接收消息。
   - WebSocket SIP
     - 会话初始协议SIP是一种信令协议，通常用于IP语音和视频会议系统。SIP是服务提供商IP多媒体子系统中的关键协议，也适用于PSTN更换的SIP中继。此外，SIP还在企业通信系统中用于统一通信以及即时消息传递和联机状态。SIP可使用UDP，TCP，SCTP或TLS作为传输机制。新的RFC定义了WebSocket SIP传输方案。
     - 此信令方案中，浏览器先加载JavaScript SIP用户代理，然后与支持WebSocket传输的SIP代理、注册服务器建立连接，发起WebRTC会话的浏览器将向代理服务器发送一条包含SDP提议的INVITE并生成相应的SIP相应，以通过200ok相应返回SDP应答，从而建立媒体会话。
 5.WebSocket Jingle
   - Jingle是对可扩展消息传递和联机状态协议XMPP的扩展，又称为Jabber，它向XMPP中添加了媒体信令功能。利用Jingle可将SDP会话描述印射至XML格式，再通过TCP或TLS传输至XMPP服务器。独立XMPP Jabber客户端通常用于即时消息传递和联机状态，GoogleTalk和其他企业IM服务都是用这种客户端。多年来，XMPP一直通过多种技术嵌入在网页之中，其中包括异步HTTP双向流，此技术可用作XMPP传输机制，有一种新的Internet草案定义了通过WebSocket传输XMPP的方案，这种方案有望提供更好的性能和互操作性。
   - Jingle实现WebRTC信令通道：
     - 从网页中下载并运行以JavaScript编写的Jingle XMPP客户端。该客户端将通过WebSocket建立通向XMPP副武器的XMPP链接，随后，该客户端会将浏览器生成的SDP提议和应答映射到Jingle调用设置消息中，并将它们转发给另一端的浏览器。另一端的浏览器将由Jabber ID表示。
 
 6.数据通道专有信令
   - 对于通过数据通道发送的信令消息，其性质可以完全是专有的。某些方案甚至不通过数据通道发送SDP对象，而是通过数据通道发送信令消息，在使用这些消息在本地声称要传递给浏览器的SDP对象。
  
 7.使用叠加网络的数据通道
   - 使用数据通道构建一个叠加网络，并使用该叠加网络作为信令通道。这是一种对等模式，有助于最大限度地减少对任何服务器类型的需求。叠加网络是叠加于或位于另一个网络之上的网络。叠加网络隐藏了底层拓扑和体系结构，并为叠加网络中的其他成员提供了另一种寻址和消息传递方式叠加网络中的每个成员都跟踪处于环形中的其他相邻节点。数据通道可用于为WebRTC建立叠加信令网络。叠加网络协议将以JavaScript编写，并下载到浏览器中。Web服务器充当引导服务器，并协助浏览器加入叠加网络，从而与叠加网络中的其他浏览器建立一些数据通道连接。一旦浏览器加入叠加网络，其余叠加网络之间的所有后续消息和信令都通过数据通道传输。只有当浏览器断开叠加网络连接并需要再次引导时，Web服务器才会再次参与进来。
   - 建立叠加网络后，叠加网络中的任何成员都可以与任何其他成员交换信令消息，进而建立对等连接。
     - 对等网络的主要优点在于，她能够自我组织、自我扩展并保护隐私，对服务器要求极少。随着叠加网络不断扩大，将在新成员之间分担附加信令负载。对等信令网络也具有普通对等网络的缺点。P2P系统会占用成员的资源，因此需要更大的带宽和处理能力。此外，P2P系统还必须应对可能试图打断叠加网络运行的恶意成员。
 
 8.信令选项总结
 - WebSocket代理：提供服务器代码的WebSocket服务器，优点是：无需信令基础架构
 - 数据通道：用于建立数据通道的WebSocket或Web服务器，优点：信令延迟短并可保护信令隐私
 - XML HTTP请求：提供服务器代码的web服务器，优点：无需信令基础架构
 - SIP：支持SIP WebSocket传输的SIP注册/代理服务器，优点：易于与SIP终端或基础架构互操作，无需服务器代码
 - Jingle：支持XMPP WebSocket传输的XMPP服务器，优点：易于与Jingle终端或基础架构互操作，无需服务器代码
 - 可运行的信令通道代码
 
 9.Web服务器：
   - 除了服务于Web应用程序本身之外，Web服务器还可充当两个或更多浏览器之间的中继（提供“信令通道”），用于协商要在浏览器之间传输的媒体的目标、类型、和格式。
   - 基于Web服务器的信令方案都属于以下两个类别之一：轮询方案和面向对象方案。

 10.STUN和TURN：
  - webRTC可以设计为点对点工作,则用户可以通过路由直接连接,网络在连接的时候,客户端应用程序需要遍历NAT网关和防火墙,对等网络需要回退,以防直接链接失败,在这个过程中:
  - STUN用于webRTC API获取计算机的IP地址,在对等通信失败的情况下使用TURN服务器充当中继服务器
  - 对等网络:没有中心,每个用户既是服务器也使用其他服务器.p2p(peer节点)

 11.WebRTC安全：
   - 所有WebRTC组件都必须使用加密,且其JavaScript API仅用于安全来源(HTTPS或者本地主机).信令机制不是webRTC标准定义的,因此要确保使用安全协议.

     

 12.WebRTC包含内容：
  - 从网络摄像头获取视频
  - 使用RTCPeerConnection流视频
  - 使用RTCDataChannel传输数据
  - 设置信令服务以交换消息
  - 结合对等连接和信令
  - 拍照并通过数据通道分享
 

 13.DataChannel
  - 支持端到端的任意应用数据交换，就像WebSocket一样，但是端到端的，而且可以定义底层传输协议的交付属性，建立RTCPeerConnection连接之后，两端可以打开一个或多个信道交换文本或二进制数据
  - DataChannel有意照搬WebSocket，每个信道都会触发onerror，onclose，onopen和onmessage回调，而且每个字段也会提供同样的binaryType、bufferedAmount和protocol字段。

 14.WebSocket与DataChannel的区别
  - WebSocket构造函数需要传入WebSocket服务器的URL，而DataChannel只是RTCPeerConnection对象的一个工厂方法；
  - WebSocket作为中继，必须要有公共IP地址给客户端使用，DataChannel的任何一端都可以初始新的DataChannel会话，会话建立后就会触发onDataChannel回调；
WebSocket运行在可靠地TCP协议之上，而每个DataChannel都可以经过配置，实现自定义的交付和可靠性（UDP，DTLS，SCTP）。
 

  15.DataChannel和WebSocket API的对比
   - 大多数WebRTC应用都需要STUN服务器来实行IP查找，从而建立端到端连接。STUN服务器存在8%-10%的端到端连接可能由于网络策略存在的各种问题而失败，为此，应用可能还需要一台TRUN服务器在端到端之间转发数据（这个方法）。

 

  16.关于jsep:
   - 要想成功建立端到端的连接，必须解决这几个问题:
   - 必须通知另一端我们想打开一个端到端的连接，以便它知道开始监听到来的分组
   - 必须找出两端之间建立连接所需的路由线路，并在两端传播这个消息
   - 必须交换有关媒介和数据流的必要消息，比如协议，编码，等
 

 ----------
 
## 四、peerConnection 
  
 1.iceGatheringState属性中保存的是本地端候选项的收集状态。这个属性有3个可能的值：
  - new：对象刚刚创建，还没有联网
  - gathering：ICE代理正在收集本地候选项
  - complete：ICE代理收集过程完成。
  
 2.iceConnectionState属性中保存着端到端的连接状态，这个属性有7个可能的值
   - new：ICE代理正在收集候选项且/或正在等待远程候选项的到来
   - checking：ICE代理至少已经收到来自一个组件的远程候选项，而且正在检查候选项，但尚未发现连接；除了检查之外，可能仍然在收集
   - connected：ICE代理已经找到一条通过所有组件的可用连接，但仍在检查其他候选项，以确定是否存在更好地连接；此时仍有可能还在收集
   - completed：ICE代理已经完成收集和检查，而且发现了通过所有组件的可用连接
   - failed：ICE代理检查完了所有候选项，但至少有一个组件的连接失败；其他一些组件的连接可能成功了
   - disconnected：一或多个组件的活动检查失败，相对failed更严重，在不稳定的网络上可能会间歇性触发（不需要采取什么行动）
   - closed：ICE代理已经关闭，不再响应STUN请求

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 

 